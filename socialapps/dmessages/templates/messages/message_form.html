{% load i18n %}
{% load bootstrap_tags %}

	<script type="text/javascript">
		function save(data, statusText, xhr, $form) {
			if (data.success) {
				window.location = data.success_url;
			} else {
				for (var item in data.errors) {
					$('#message-send-errors .errorlist').html('');
					for (var error in data.errors[item]) {
						$('#message-send-errors .errorlist').append('<li>' + item + ': ' + data.errors[item][error] + '</li>');
					}
				}
			}
		}
	    $(document).ready(function() {
			$('#message-form').ajaxForm({dataType : 'json', success : save });
			{% if users %}
				$(function() {
					var availableTags = [
						{% for u in users %}
						{
							value: "{{ u.id }}",
							label: "{{ u.get_profile.name }}",
							icon: "{{ u.get_profile.get_avatar_url }}",
						},	
						{% endfor %}
					];
					function split( val ) {
						return val.split( /,\s*/ );
					}
					function extractLast( term ) {
						return split( term ).pop();
					}
					$( "#to_autocomplete" )
						// don't navigate away from the field on tab when selecting an item
						.bind( "keydown", function( event ) {
							if ( event.keyCode === $.ui.keyCode.TAB &&
									$( this ).data( "autocomplete" ).menu.active ) {
								event.preventDefault();
							}
					}).autocomplete({
						minLength: 0,
						source: function( request, response ) {
							// delegate back to autocomplete, but extract the last term
							response( $.ui.autocomplete.filter(
								availableTags, extractLast( request.term ) ) );
						},
						focus: function() {
							// prevent value inserted on focus
							return false;
						},
						select: function( event, ui ) {
							var terms = split( this.value );
							// remove the current input
							terms.pop();
							// add the selected item
							terms.push( ui.item.label );
							// add placeholder to get the comma-and-space at the end
							terms.push( "" );
							this.value = terms.join( ", " );
							//again for users id
							var terms = split( $( "#id_to" ).val() );
							// remove the current input
							terms.pop();
							// add the selected item
							terms.push( ui.item.value );
							// add placeholder to get the comma-and-space at the end
							terms.push( "" );
							$( "#id_to" ).val(terms.join( ","));
							return false;
						}
					}).data( "autocomplete" )._renderItem = function( ul, item ) {
						return $( "<li></li>" )
							.data( "item.autocomplete", item )	
							.append( "<a><img width='16' height='16' src='" + item.icon + "'/>" + item.label + "</a>" )
							.appendTo( ul );
					};
				});
			{% endif %}
	    });
	</script>

<div class="modal-header">
	<a class="close" data-dismiss="modal">Ã—</a>
	<h3>{% trans "Send message" %}</h3>
</div>
<form action="{% url socialapps_messages_compose %}" method="post" class="form-horizontal" id="message-form">
	{% csrf_token %}
	<input type="hidden" name="next" id="id_next" value="{{ request.REQUEST.next }}" />
		<div class="modal-body">
			<div id="message-send-errors"><ul class="errorlist"></ul></div>	
			<fieldset>
				{% if users %}
					<div class="clearfix">
						<label for="to_autocomplete">{% trans "To" %}</label>
						<div class="input">
							<input type="text" id="to_autocomplete" val=""/>
						</div>
					</div>
				{% endif %}
				{{ form|as_bootstrap }}
	  		</fieldset>
		</div>
		<div class="modal-footer">			
	  		<input type="submit" name="send" value="{% trans "Send" %}" class="btn btn-primary"/>
			<a href="#" class="btn" data-dismiss="modal">{% trans "Cancel" %}</a>
		  </div>
</form>
</div>
